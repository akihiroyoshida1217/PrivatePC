# Generated by iptables-save v1.6.0 on Sat Jun 30 18:06:43 2018
*filter

-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 80 -j ACCEPT
-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 443 -j ACCEPT
-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 22 -j ACCEPT
-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 23 -j ACCEPT
-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 3389 -j ACCEPT
-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 139 -j ACCEPT
-A OUTPUT -d {{ private_network_address }}  -p tcp --dport 445 -j ACCEPT
-A OUTPUT -d 172.16.0.0/12 -p tcp --dport 5900 -j ACCEPT
-A OUTPUT -d 172.16.0.0/12 -p tcp --dport 10022 -j ACCEPT

-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT ! -o lo -d 127.0.0.0/8 -j REJECT
#-A OUTPUT -i lo -p icmp --icmp-type any -j REJECT

-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
#-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

-A OUTPUT -p udp --dport 53 -j ACCEPT

# ntp.nict.jp
{% for ip in lookup('dnsqueryloop', 'ntp.nict.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p udp --dport 123 -j ACCEPT
{% endfor %}

# ftp.nara.wide.ad.jp
{% for ip in lookup('dnsqueryloop', 'ftp.nara.wide.ad.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ftp.tsukuba.wide.ad.jp
{% for ip in lookup('dnsqueryloop', 'ftp.tsukuba.wide.ad.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# dennou-h.gfd-dennou.org
{% for ip in lookup('dnsqueryloop', 'dennou-h.gfd-dennou.org', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# dennou-k.gfd-dennou.org
{% for ip in lookup('dnsqueryloop', 'dennou-k.gfd-dennou.org', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# dennou-q.gfd-dennou.org
{% for ip in lookup('dnsqueryloop', 'dennou-q.gfd-dennou.org', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# debian-mirror.sakura.ne.jp
{% for ip in lookup('dnsqueryloop', 'debian-mirror.sakura.ne.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# riksun.riken.go.jp
{% for ip in lookup('dnsqueryloop', 'riksun.riken.go.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# infoserv.ics.es.osaka-u.ac.jp
{% for ip in lookup('dnsqueryloop', 'infoserv.ics.es.osaka-u.ac.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ftp.kddilabs.jp
{% for ip in lookup('dnsqueryloop', 'ftp.kddilabs.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ring.shibaura-it.ac.jp
{% for ip in lookup('dnsqueryloop', 'ring.shibaura-it.ac.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ring.u-toyama.ac.jp
{% for ip in lookup('dnsqueryloop', 'ring.u-toyama.ac.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ring.airnet.ne.jp
{% for ip in lookup('dnsqueryloop', 'ring.airnet.ne.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ring.ix.oita-u.ac.jp
{% for ip in lookup('dnsqueryloop', 'ring.ix.oita-u.ac.jp', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# security.debian.org
{% for ip in lookup('dnsqueryloop', 'security.debian.org', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}
# ftp.jp.debian.org(jp.cdn.araki.net)
{% for ip in lookup('dnsqueryloop', 'jp.cdn.araki.net', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}

# github.com
{% for ip in lookup('dnsqueryloop', 'github.com', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 443 -j ACCEPT
{% endfor %}
# codeload.github.com
{% for ip in lookup('dnsqueryloop', 'codeload.github.com', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 443 -j ACCEPT
{% endfor %}

# security-cdn.debian.org(prod.debian.map.fastly.net)
{% for ip in lookup('dnsqueryloop', 'prod.debian.map.fastly.net', 'A').split(',') %}
-A OUTPUT -d {{ ip }} -p tcp --dport 80 -j ACCEPT
{% endfor %}

-A INPUT -j LOG --log-prefix "iptables denied: " --log-level 7
-A OUTPUT -j LOG --log-prefix "iptables denied: " --log-level 7

#-A OUTPUT -j ACCEPT
-A OUTPUT -j REJECT
-A INPUT -j REJECT
-A FORWARD -j REJECT

COMMIT
# Completed on Sat Jun 30 18:06:43 2018
